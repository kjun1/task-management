{{- if or .Params.math .Site.Params.math -}}
<!-- Load KaTeX CSS asynchronously to prevent render blocking -->
<link rel="preload" href="{{ "css/katex.min.css" | absURL }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ "css/katex.min.css" | absURL }}"></noscript>
<script defer src="{{ "js/katex.min.js" | absURL }}"></script>
<script defer src="{{ "js/auto-render.min.js" | absURL }}"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\[', right: '\\]', display: true}
            ],
            throwOnError: false,
            // Optimize DOM structure
            output: 'html',
            strict: false,
            // Reduce nesting in math expressions
            macros: {
                "\\RR": "\\mathbb{R}",
                "\\NN": "\\mathbb{N}",
                "\\ZZ": "\\mathbb{Z}",
                "\\QQ": "\\mathbb{Q}",
                "\\CC": "\\mathbb{C}"
            },
            // Reduce DOM complexity for large expressions
            maxSize: 25,
            maxExpand: 10
        });
    });
</script>
{{- end -}}