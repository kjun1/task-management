# ä¾å­˜é–¢ä¿‚ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ç›£è¦–
name: Security & Dependencies

on:
  schedule:
    # æ¯é€±æœˆæ›œæ—¥ 9:00 JST
    - cron: '0 0 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Check Hugo version
        run: |
          CURRENT_VERSION="0.150.0"
          LATEST_VERSION=$(curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | grep '"tag_name"' | cut -d'"' -f4 | sed 's/v//')
          echo "Current: $CURRENT_VERSION"
          echo "Latest: $LATEST_VERSION"
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "::warning::Hugo update available: $LATEST_VERSION"
          fi

      - name: Check theme updates
        run: |
          cd themes/PaperMod
          git fetch origin
          BEHIND=$(git rev-list --count HEAD..origin/master)
          if [ "$BEHIND" -gt 0 ]; then
            echo "::warning::PaperMod theme is $BEHIND commits behind"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Generate lockfile if missing
        run: |
          if [ -f "package.json" ] && [ ! -f "package-lock.json" ]; then
            echo "Generating package-lock.json..."
            npm install --package-lock-only
          else
            echo "package-lock.json already exists or no package.json found"
          fi

      - name: Security audit (if package.json exists)
        run: |
          if [ -f "package.json" ]; then
            echo "Running npm audit..."
            npm audit --audit-level moderate
          else
            echo "No package.json found, skipping npm audit"
          fi

  lighthouse-audit:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.150.0
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
          sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Build site
        run: hugo --gc --minify

      - name: Setup Node.js for Lighthouse
        uses: actions/setup-node@v5
        with:
          node-version: 'lts/*'

      - name: Install Lighthouse
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        id: lighthouse
        run: |
          echo "Starting Lighthouse CI..."
          lhci autorun --upload.target=temporary-public-storage --collect.staticDistDir=./public 2>&1 | tee lighthouse-output.txt || echo "Lighthouse completed with warnings"
          
          # ãƒ¬ãƒãƒ¼ãƒˆURLã‚’æŠ½å‡º
          echo "Extracting report URLs..."
          grep -o 'https://storage.googleapis.com/lighthouse-infrastructure.appspot.com/reports/[^"]*\.report\.html' lighthouse-output.txt > report-urls.txt || echo "No report URLs found"
          
          # çµæœã‚’GitHub Actionsã®å‡ºåŠ›ã«è¨­å®š
          if [ -s report-urls.txt ]; then
            echo "reports_found=true" >> $GITHUB_OUTPUT
            echo "report_count=$(wc -l < report-urls.txt)" >> $GITHUB_OUTPUT
          else
            echo "reports_found=false" >> $GITHUB_OUTPUT
            echo "report_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Create Lighthouse Report Issue
        if: steps.lighthouse.outputs.reports_found == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reportUrls = fs.readFileSync('report-urls.txt', 'utf8').trim().split('\n').filter(url => url);
            const reportCount = reportUrls.length;
            
            // ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
            const now = new Date();
            const jstDate = new Date(now.getTime() + (9 * 60 * 60 * 1000)); // JSTå¤‰æ›
            const dateStr = jstDate.toISOString().split('T')[0];
            const timeStr = jstDate.toTimeString().split(' ')[0];
            
            // Issueã®ã‚¿ã‚¤ãƒˆãƒ«ã¨æœ¬æ–‡ã‚’ä½œæˆ
            const title = `ğŸ“Š Lighthouse ãƒ¬ãƒãƒ¼ãƒˆ - ${dateStr}`;
            
            let body = `# ğŸš€ Lighthouse å“è³ªç›£æŸ»ãƒ¬ãƒãƒ¼ãƒˆ
            
## ğŸ“… å®Ÿè¡Œæ—¥æ™‚
**${dateStr} ${timeStr} (JST)**

## ğŸ“ˆ æ¸¬å®šçµæœ
åˆè¨ˆ **${reportCount}** ãƒšãƒ¼ã‚¸ã‚’æ¸¬å®šã—ã¾ã—ãŸã€‚

### ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆä¸€è¦§
`;

            // ãƒ¬ãƒãƒ¼ãƒˆURLã‚’ãƒšãƒ¼ã‚¸åˆ¥ã«æ•´ç†
            reportUrls.forEach((url, index) => {
              const pageMatch = url.match(/localhost:36367\/(.+?)\.html/);
              const pageName = pageMatch ? pageMatch[1] : `Page ${index + 1}`;
              const displayName = pageName
                .replace('index', 'ãƒ›ãƒ¼ãƒ ')
                .replace('404', 'ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸')
                .replace('categories/index', 'ã‚«ãƒ†ã‚´ãƒªä¸€è¦§')
                .replace('example-project/index', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¾‹')
                .replace('external-layer-specification/index', 'å¤–éƒ¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ä»•æ§˜')
                .replace('/index', '')
                || 'ãã®ä»–ã®ãƒšãƒ¼ã‚¸';
              
              body += `- ğŸ“„ **${displayName}**: [ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹](${url})\n`;
            });

            body += `
## ğŸ” ç¢ºèªãƒã‚¤ãƒ³ãƒˆ
ä»¥ä¸‹ã®è¦³ç‚¹ã§ã‚µã‚¤ãƒˆã®å“è³ªã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- **âš¡ Performance**: ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿é€Ÿåº¦
- **â™¿ Accessibility**: ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ
- **ğŸ¯ Best Practices**: Webé–‹ç™ºã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- **ğŸ” SEO**: æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³æœ€é©åŒ–
- **ğŸ“± PWA**: ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–Webã‚¢ãƒ—ãƒªå¯¾å¿œ

## ğŸ“ æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
ãƒ¬ãƒãƒ¼ãƒˆã§ç™ºè¦‹ã•ã‚ŒãŸå•é¡ŒãŒã‚ã‚Œã°ã€ä»¥ä¸‹ã®å½¢å¼ã§ã‚³ãƒ¡ãƒ³ãƒˆã—ã¦ãã ã•ã„ï¼š

\`\`\`
### ğŸ“„ [ãƒšãƒ¼ã‚¸å]
- âŒ **å•é¡Œ**: [å•é¡Œã®èª¬æ˜]
- âœ… **å¯¾å¿œ**: [å¯¾å¿œæ–¹æ³•]
- ğŸ”— **å‚è€ƒ**: [å‚è€ƒãƒªãƒ³ã‚¯]
\`\`\`

---
*ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ Security & Dependencies ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
*æ¬¡å›å®Ÿè¡Œäºˆå®š: æ¥é€±æœˆæ›œæ—¥ 9:00 JST*
`;

            // Issueã‚’ä½œæˆ
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['lighthouse', 'quality-check', 'å“è³ªç›£æŸ»']
            });
            
            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);

      - name: Cleanup temporary files
        if: always()
        run: |
          rm -f lighthouse-output.txt report-urls.txt || true