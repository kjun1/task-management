# 依存関係とセキュリティの監視
name: Security & Dependencies

on:
  schedule:
    # 毎週月曜日 9:00 JST
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Check Hugo version
        run: |
          CURRENT_VERSION="0.150.0"
          LATEST_VERSION=$(curl -s https://api.github.com/repos/gohugoio/hugo/releases/latest | grep '"tag_name"' | cut -d'"' -f4 | sed 's/v//')
          echo "Current: $CURRENT_VERSION"
          echo "Latest: $LATEST_VERSION"
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "::warning::Hugo update available: $LATEST_VERSION"
          fi

      - name: Check theme updates
        run: |
          cd themes/PaperMod
          git fetch origin
          BEHIND=$(git rev-list --count HEAD..origin/master)
          if [ "$BEHIND" -gt 0 ]; then
            echo "::warning::PaperMod theme is $BEHIND commits behind"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 'lts/*'
          cache: 'npm'
        if: ${{ hashFiles('package.json') != '' }}

      - name: Generate lockfile if missing
        run: |
          if [ -f "package.json" ] && [ ! -f "package-lock.json" ]; then
            echo "Generating package-lock.json..."
            npm install --package-lock-only
          fi
        if: ${{ hashFiles('package.json') != '' }}

      - name: Security audit (if package.json exists)
        run: |
          if [ -f "package.json" ]; then
            npm audit --audit-level moderate
          else
            echo "No package.json found, skipping npm audit"
          fi

  lighthouse-audit:
    runs-on: ubuntu-latest
    env:
      HUGO_VERSION: 0.150.0
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install Hugo
        run: |
          wget -O ${{ runner.temp }}/hugo.deb https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_linux-amd64.deb
          sudo dpkg -i ${{ runner.temp }}/hugo.deb

      - name: Build site
        run: hugo --gc --minify

      - name: Setup Node.js for Lighthouse
        uses: actions/setup-node@v5
        with:
          node-version: 'lts/*'

      - name: Install Lighthouse
        run: npm install -g @lhci/cli@0.12.x

      - name: Run Lighthouse CI
        run: |
          lhci autorun --upload.target=temporary-public-storage --collect.staticDistDir=./public || echo "Lighthouse completed with warnings"